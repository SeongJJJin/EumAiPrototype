<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>분석 결과</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/table-style.css' %}">
    <link rel="stylesheet" href="{% static 'css/button-style.css' %}">
    <link rel="stylesheet" href="{% static 'css/modal-style.css' %}">
    <link rel="stylesheet" href="{% static 'css/image-style.css' %}">
</head>
<body>
    <div>
        <button id="inference-btn" onclick="location.href='http://127.0.0.1:8000/inference_start/'">하자 리스트 불러오기</button>
    </div>
    <div id="all-apply-container">
        <button id="all-apply-btn">모두 적용하기</button>
    </div>
    <div id="container">
        <div id="result-container">
            <div>
                <h3>전체 하자</h3>
                <p>{{ final_data.status_waited_count }} 건</p>
            </div>
            <div>
                <h3>분류 하자</h3>
                <p>도배 {{ final_data.wall_count}} 건</p>
                <p>타일 {{ final_data.tile_count}} 건</p>
                <p>기타 {{ final_data.etc_count}} 건</p>
            </div>
            <div>
                <h3>제외 하자</h3>
                <p>{{ final_data.remove_count}} 건</p>
            </div>
        </div>
    </div>

    <div id="table-container">
        {% if final_data %}
            <table>
                <thead>
                    <tr>
                        <th>번호</th>
                        <th>동</th>
                        <th>호수</th>
                        <th>위치</th>
                        <th>내용</th>
                        <th>공종</th>
                        <th>세부공종</th>
                        <th>하자유형</th>
                        <th>이미지</th>
                        <th>제외/적용</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, result in final_data.defect_list.items %}
                        <tr>
                            <td>{{ key }}</td>
                            <td>{{ result.dong }}</td>
                            <td>{{ result.ho }}</td>
                            <td>{{ result.location }}</td>
                            <td>{{ result.content }}</td>
                            <td>
                                <div class="modal-container">
                                    <select onchange="updateData('{{ key }}', 'construct_type', this.value)">
                                        {% if result.construct_type %}
                                        <option value="{{ result.construct_type }}" selected>{{ result.construct_type }}</option>
                                        {% else %}
                                            <option value=" " selected>선택해주세요.</option>
                                        {% endif %}

                                        <!-- 아래 옵션들은 실제 현장과 맵핑된 데이터를 고를 수 있어야 한다.-->
                                        <option value="option2" {% if result.construct_type == 'option2' %}selected{% endif %}>Option 2</option>
                                    </select>
                                </div>
                            </td>
                            <td>
                                <div class="modal-container">
                                    <select onchange="updateData('{{ key }}', 'detail_construct_type', this.value)">
                                        {% if result.detail_construct_type != " "%}
                                            <option value="{{ result.detail_construct_type }}">{{ result.detail_construct_type }}</option>
                                        {% else %}
                                            <option value=" " selected>선택해주세요.</option>
                                        {% endif %}

                                        <!-- 아래 옵션들은 실제 현장과 맵핑된 데이터를 고를 수 있어야 한다.-->
                                        <option value="option2" {% if result.detail_construct_type == 'option2' %}selected{% endif %}>Option 2</option>
                                    </select>
                                </div>
                            </td>
                            <td>
                                <div class="modal-container">
                                    <select onchange="updateData('{{ key }}', 'defect', this.value)">
                                        {% if result.defect != " "%}
                                            <option value="{{ result.defect }}"> {{ result.defect }} </option>
                                        {% else %}
                                            <option value=" " selected>선택해주세요.</option>
                                        {% endif %}

                                        <!-- 아래 옵션들은 실제 현장과 맵핑된 데이터를 고를 수 있어야 한다.-->
                                        <option value="option2" {% if result.defect == 'option2' %}selected{% endif %}>Option 2</option>
                                    </select>
                                </div>
                            </td>
                            <td>
                                {% if result.images %}
                                    <div class="scroll-container">
                                        {% for image in result.images %}
                                            <img src="{{ image }}" alt="이미지" onclick="zoomImage(this)" style="max-width: 100px; height: auto;">
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    이미지 없음
                                {% endif %}
                            </td>
                            <td>
                                <div id="exclude-apply-button-container">
                                    <button id="exclude-btn">제외하기</button>
                                    <button id="apply-btn">적용하기</button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>결과가 없습니다.</p>
        {% endif %}
    </div>

    <!-- 모달 창 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2>내용 수정</h2>
            <input type="hidden" id="modal-key">
            <input type="hidden" id="modal-field">
            <label for="modal-value">값:</label>
            <select id="modal-value">
                <!-- 옵션은 JavaScript로 동적으로 채워짐 -->
            </select>
            <button onclick="saveChanges()">저장</button>
            <button onclick="closeModal()">닫기</button>
        </div>
    </div>

    <script>
        function zoomImage(img) {
            window.open(img.src, '_blank');
        }

        function updateData(key, field, value) {
            fetch('/update_data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    key: key,
                    field: field,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('업데이트 성공');
                } else {
                    console.error('업데이트 실패');
                }
            })
            .catch(error => {
                console.error('에러 발생:', error);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('tbody tr');
            console.log('Row:', rows);

            rows.forEach(row => {
                const detailConstructTypeCell = row.querySelector('td:nth-child(6) select');

                if (detailConstructTypeCell && detailConstructTypeCell.value.trim() === "") {
                    console.log('Detail Construct Type Cell:', detailConstructTypeCell);
                    row.classList.add('highlight-row');
                }
            });
        });
    </script>
</body>
</html>
